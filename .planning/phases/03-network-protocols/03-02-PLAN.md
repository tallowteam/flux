---
phase: 03-network-protocols
plan: 02
type: execute
wave: 2
depends_on:
  - "03-01"
files_modified:
  - src/backend/sftp.rs
  - src/backend/mod.rs
  - Cargo.toml
  - tests/sftp_backend.rs
autonomous: true
requirements:
  - PROT-03

must_haves:
  truths:
    - "SftpBackend implements FluxBackend trait with all 6 methods"
    - "SFTP connection authenticates via SSH agent, then key files, then password prompt"
    - "Files can be read from and written to SFTP servers through the FluxBackend interface"
    - "Directory operations (stat, list_dir, create_dir_all) work over SFTP"
    - "SftpBackend reports supports_parallel: false and supports_seek: false"
    - "Backend factory creates SftpBackend when protocol is Sftp"
  artifacts:
    - path: "src/backend/sftp.rs"
      provides: "SftpBackend struct implementing FluxBackend"
      min_lines: 100
      contains: "impl FluxBackend for SftpBackend"
    - path: "Cargo.toml"
      provides: "ssh2 dependency with vendored-openssl"
      contains: "ssh2"
  key_links:
    - from: "src/backend/sftp.rs"
      to: "ssh2 crate"
      via: "Session::new, Sftp methods"
      pattern: "ssh2::Session"
    - from: "src/backend/mod.rs"
      to: "src/backend/sftp.rs"
      via: "create_backend match arm for Protocol::Sftp"
      pattern: "SftpBackend::connect"
---

<objective>
Implement the SFTP backend so users can transfer files to/from SFTP servers using `flux cp file.txt sftp://user@host/path/`.

Purpose: SFTP is the most common network file transfer protocol. The ssh2 crate provides a natively synchronous API that maps directly to the FluxBackend trait, making this the most straightforward network backend.

Output: Working SftpBackend that connects via SSH, authenticates (agent/key/password), and implements all FluxBackend methods. Backend factory updated to create SftpBackend for SFTP protocol.
</objective>

<execution_context>
@C:/Users/trima/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/trima/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-network-protocols/03-RESEARCH.md
@.planning/phases/03-network-protocols/03-01-SUMMARY.md
@src/backend/mod.rs
@src/backend/local.rs
@src/error.rs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Implement SftpBackend with ssh2 crate</name>
  <files>
    src/backend/sftp.rs
    src/backend/mod.rs
    src/error.rs
    Cargo.toml
  </files>
  <action>
1. Add `ssh2 = { version = "0.9", features = ["vendored-openssl"] }` to Cargo.toml dependencies.

2. Create `src/backend/sftp.rs`:

   **SftpBackend struct:**
   ```rust
   pub struct SftpBackend {
       session: ssh2::Session,
       sftp: ssh2::Sftp,
       base_path: String,  // remote base path from the URL
   }
   ```

   **Connection and authentication (`SftpBackend::connect`):**
   - Accept user, host, port, and optional password/key_path from Protocol::Sftp and Auth enum
   - Create `TcpStream::connect((host, port))` with a reasonable timeout (30 seconds via `connect_timeout`)
   - Create `ssh2::Session::new()`, set tcp stream, call `handshake()`
   - Authentication cascade (try in order, stop on first success):
     a. SSH agent: `session.userauth_agent(&user)` — works if ssh-agent is running
     b. Key files: try `~/.ssh/id_ed25519`, `~/.ssh/id_rsa`, `~/.ssh/id_ecdsa` via `session.userauth_pubkey_file(user, None, &key_path, None)`
     c. Password: if user provided password inline (from URL userinfo), use `session.userauth_password(user, password)`
     d. Password prompt: use `rpassword::prompt_password("Password for {user}@{host}: ")` then `session.userauth_password`
   - If all auth methods fail, return `FluxError::ProtocolError("SFTP authentication failed: ...")`
   - Create `session.sftp()` and store in struct
   - Return `Ok(SftpBackend { session, sftp, base_path })`

   **FluxBackend implementation:**

   `stat()`: Call `self.sftp.stat(path)`. Convert `ssh2::FileStat` to `crate::backend::FileStat`:
   - `size`: `stat.size.unwrap_or(0)`
   - `is_dir`: `stat.is_dir()`
   - `is_file`: `stat.is_file()` (or `!stat.is_dir()` if `is_file` not available)
   - `modified`: Convert `stat.mtime` (Option<u64> seconds since epoch) to `SystemTime` via `UNIX_EPOCH + Duration::from_secs(mtime)`
   - `permissions`: `stat.perm`

   `list_dir()`: Call `self.sftp.readdir(path)`. Map each `(PathBuf, FileStat)` entry to `FileEntry`. Filter out `.` and `..` entries.

   `open_read()`: Call `self.sftp.open(path)` with `ssh2::OpenFlags::READ`. ssh2::File implements `Read + Send`, so wrap: `Ok(Box::new(file))`.

   `open_write()`: Call `self.sftp.create(path)` to create/truncate. ssh2::File implements `Write + Send`, so wrap: `Ok(Box::new(file))`. NOTE: If sftp.create doesn't create parent dirs, handle that in the caller.

   `create_dir_all()`: SFTP `mkdir` only creates one level. Implement by splitting path into components and creating each level, ignoring "already exists" errors. Use `self.sftp.mkdir(component, 0o755)` and catch errors where the dir already exists.

   `features()`: Return `BackendFeatures { supports_seek: false, supports_parallel: false, supports_permissions: true }`.

   **Error mapping:** Create a helper `fn sftp_err(e: ssh2::Error) -> FluxError` that wraps ssh2 errors into `FluxError::Io` by converting to `std::io::Error` (ssh2::Error implements `Into<io::Error>`).

3. Add `pub mod sftp;` to `src/backend/mod.rs`.

4. Update `create_backend()` in `src/backend/mod.rs`:
   - Replace the `Protocol::Sftp` stub error with:
     ```rust
     Protocol::Sftp { user, host, port, path } => {
         let backend = sftp::SftpBackend::connect(user, host, *port, path, /* auth from protocol */)?;
         Ok(Box::new(backend))
     }
     ```
   - Pass auth information from the protocol detection (password from URL userinfo if present).

5. Add `ConnectionFailed { protocol: String, host: String, reason: String }` variant to FluxError for connection-level failures (distinct from ProtocolError which is about protocol support).
  </action>
  <verify>
Run `cargo build` — compiles without errors. Run `cargo test` — all existing tests pass. The ssh2 vendored-openssl build may take several minutes on first compile. Verify `SftpBackend` struct exists and implements `FluxBackend`.
  </verify>
  <done>
SftpBackend compiles, implements all 6 FluxBackend methods, authenticates via agent/key/password cascade, and is wired into the backend factory. ssh2 with vendored-openssl builds successfully on Windows.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add SFTP unit tests and integration test stubs</name>
  <files>
    tests/sftp_backend.rs
    src/backend/sftp.rs
  </files>
  <action>
1. Add unit tests in `src/backend/sftp.rs` `#[cfg(test)] mod tests`:
   - Test `sftp_err` helper correctly maps ssh2 errors to FluxError::Io
   - Test `features()` returns correct BackendFeatures (supports_parallel: false, supports_seek: false, supports_permissions: true)
   - Test `create_dir_all` path splitting logic (mock-free: test the path component extraction logic as a separate function)

2. Create `tests/sftp_backend.rs` integration test:
   - Test that `flux cp localfile.txt sftp://user@host/path` attempts connection (will fail with connection refused/timeout in CI, but validates the protocol routing works end-to-end)
   - Mark network-dependent tests with `#[ignore]` attribute so they don't run in normal `cargo test` but can be run with `cargo test -- --ignored` when an SFTP server is available
   - Add an ignored test that documents how to test with a real SFTP server:
     ```rust
     #[test]
     #[ignore] // Requires SFTP server: SFTP_TEST_HOST, SFTP_TEST_USER env vars
     fn sftp_upload_download_roundtrip() {
         // Read env vars for test server
         // Upload a temp file, download it, compare contents
     }
     ```

3. Ensure all non-ignored tests pass with `cargo test`.
  </action>
  <verify>
Run `cargo test` — all tests pass (ignored SFTP tests skipped). Run `cargo test -- --list` shows the new sftp test functions. `cargo test sftp` runs the non-ignored sftp tests.
  </verify>
  <done>
SFTP backend has unit tests for error mapping and features. Integration test stubs exist for manual testing against real SFTP servers. All non-network tests pass in CI.
  </done>
</task>

</tasks>

<verification>
- `cargo build` succeeds (ssh2 vendored-openssl compiles)
- `cargo test` passes all existing + new non-ignored tests
- `SftpBackend` implements all 6 FluxBackend trait methods
- `create_backend(Protocol::Sftp { ... })` returns Ok(Box<SftpBackend>)
- `flux cp file sftp://user@host/path` attempts real SFTP connection (not stub error)
- BackendFeatures reports supports_parallel: false, supports_seek: false
</verification>

<success_criteria>
SFTP backend is fully implemented with ssh2, authenticates via agent/key/password cascade, implements all FluxBackend methods, and is wired into the backend factory. Users can attempt `flux cp file sftp://user@host/path/` and the tool will try to connect and transfer.
</success_criteria>

<output>
After completion, create `.planning/phases/03-network-protocols/03-02-SUMMARY.md`
</output>
