---
phase: 06-tui-mode
plan: 03
type: execute
wave: 2
depends_on:
  - 06-01
files_modified:
  - src/tui/components/file_browser.rs
  - src/tui/components/mod.rs
  - src/tui/app.rs
autonomous: true
requirements:
  - TUI-03

must_haves:
  truths:
    - "User can see a list of files and directories in the current directory"
    - "User can navigate up/down the file list with j/k or arrow keys"
    - "User can enter a directory with Enter key"
    - "User can go back to parent directory with Backspace or h key"
    - "Directories are shown with trailing / and sorted before files"
    - "Files show their size in human-readable format"
    - "Current path is shown in the browser header"
  artifacts:
    - path: "src/tui/components/file_browser.rs"
      provides: "FileBrowserComponent with directory listing, navigation, and file selection"
      contains: "FileBrowserComponent"
      min_lines: 100
  key_links:
    - from: "src/tui/components/file_browser.rs"
      to: "src/backend/mod.rs"
      via: "Uses FluxBackend::list_dir() and FluxBackend::stat() for directory browsing"
      pattern: "FluxBackend|list_dir|LocalBackend"
    - from: "src/tui/app.rs"
      to: "src/tui/components/file_browser.rs"
      via: "App delegates Files tab rendering to FileBrowserComponent"
      pattern: "file_browser.*render|FileBrowserComponent"
---

<objective>
Create the File Browser component enabling users to browse local (and potentially remote) file systems using keyboard navigation within the TUI.

Purpose: Allows users to visually navigate directories and select files for transfer, replacing the need to type out full paths. Uses the existing FluxBackend trait for file system access, enabling future remote browsing.

Output: Working FileBrowserComponent that lists directory contents, supports keyboard navigation, and integrates with the App's tab system.
</objective>

<execution_context>
@C:/Users/trima/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/trima/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-tui-mode/06-RESEARCH.md
@.planning/phases/06-tui-mode/06-01-SUMMARY.md
@src/backend/mod.rs
@src/backend/local.rs
@src/tui/components/mod.rs
@src/tui/app.rs
@src/tui/action.rs
@src/tui/theme.rs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create FileBrowserComponent with directory listing and navigation</name>
  <files>
    src/tui/components/file_browser.rs
    src/tui/components/mod.rs
  </files>
  <action>
1. Create `src/tui/components/file_browser.rs`:

   **BrowserEntry** (display-friendly file entry):
   ```rust
   pub struct BrowserEntry {
       pub name: String,        // Display name (file/dir name only, not full path)
       pub full_path: PathBuf,  // Full path for navigation
       pub is_dir: bool,
       pub size: u64,
       pub modified: Option<SystemTime>,
   }
   ```

   **FileBrowserComponent**:
   ```rust
   pub struct FileBrowserComponent {
       current_dir: PathBuf,
       entries: Vec<BrowserEntry>,
       list_state: ListState,
       error_message: Option<String>,
       loading: bool,
   }
   ```

   **Constructor:**
   - `pub fn new() -> Self` -- starts at current working directory (`std::env::current_dir()`)
   - Calls `navigate_to()` to populate initial listing

   **Navigation methods:**
   - `pub fn navigate_to(&mut self, path: &Path)`:
     - Create a `LocalBackend` (use existing `crate::backend::local::LocalBackend::new()`)
     - Call `backend.list_dir(path)` to get entries
     - Convert `Vec<FileEntry>` to `Vec<BrowserEntry>` extracting file names
     - Sort: directories first (by is_dir descending), then alphabetically by name (case-insensitive)
     - Prepend a ".." entry (parent directory) if not at root
     - Update `self.current_dir`, `self.entries`, reset `self.list_state.select(Some(0))`
     - On error, set `self.error_message` with the error string, keep current entries
   - `pub fn enter_selected(&mut self)`:
     - Get currently selected entry from list_state
     - If it's a directory (or ".."), call `navigate_to()` with its full_path
     - If it's "..", navigate to `self.current_dir.parent()`
     - If it's a file, do nothing for now (future: could trigger transfer)
   - `pub fn go_parent(&mut self)`:
     - Navigate to `self.current_dir.parent()` if available
   - `pub fn selected_entry(&self) -> Option<&BrowserEntry>`:
     - Return the currently selected entry based on list_state

   **Component trait implementation:**
   - `handle_key_event`:
     - `KeyCode::Up | KeyCode::Char('k')` -> select previous in list_state
     - `KeyCode::Down | KeyCode::Char('j')` -> select next in list_state
     - `KeyCode::Enter | KeyCode::Char('l')` -> `enter_selected()` (Enter directory or select file)
     - `KeyCode::Backspace | KeyCode::Char('h')` -> `go_parent()` (Go up one level)
     - `KeyCode::Home` -> `list_state.select(Some(0))` (jump to top)
     - `KeyCode::End` -> `list_state.select(Some(entries.len() - 1))` (jump to bottom)
     - Return appropriate Action

   - `render(frame, area)`:
     - Layout: single area (full tab content) for file list
     - If `loading`, show a Block with "Loading..." text
     - If `error_message`, show error in a styled Paragraph at top
     - Create `Vec<ListItem>` from entries:
       - Directories: `"  {name}/"` in bold/blue style
       - Files: `"  {name}  ({size})"` in default style, size via `bytesize::ByteSize`
       - ".." entry: `"  ../"` in dim style
     - Use `List` widget with:
       - `Block::bordered().title(format!(" {} ", self.current_dir.display()))`
       - `highlight_style` using `theme::SELECTED`
       - `highlight_symbol(">> ")`
     - Render with `frame.render_stateful_widget(list, area, &mut self.list_state)`

2. In `src/tui/components/mod.rs`:
   - Add `pub mod file_browser;`
  </action>
  <verify>
    `cargo check` passes. Module compiles with all methods.
  </verify>
  <done>
    FileBrowserComponent exists with directory listing via LocalBackend, keyboard navigation (j/k/Enter/Backspace), directory sorting, and List widget rendering.
  </done>
</task>

<task type="auto">
  <name>Task 2: Integrate FileBrowserComponent into App</name>
  <files>
    src/tui/app.rs
  </files>
  <action>
1. In `src/tui/app.rs`:
   - Add `use super::components::file_browser::FileBrowserComponent;`
   - Add `file_browser: FileBrowserComponent` field to App struct
   - In `App::new()`, create `FileBrowserComponent::new()`
   - In `App::render()`, when `active_tab` is `ActiveTab::FileBrowser`:
     - Call `self.file_browser.render(frame, content_area)`
   - In `App::handle_key_event()`, when `active_tab` is `ActiveTab::FileBrowser`:
     - Delegate to `self.file_browser.handle_key_event(key)`
   - Update status bar hints when Files tab is active:
     - Change hints to show file browser controls: `j/k:Navigate | Enter:Open | Backspace:Parent | q:Quit`
     - Can either swap status_bar.hints based on active_tab, or have the status bar always show the active tab's relevant hints. Simplest: update hints in render() based on active_tab before rendering the status bar.
  </action>
  <verify>
    `cargo build` succeeds. Run `flux ui`, press `2` to switch to Files tab. Verify: current directory's files and folders are listed, j/k scrolls through them, Enter opens directories, Backspace goes to parent, header shows current path. Return to Dashboard with `1`.
  </verify>
  <done>
    Files tab shows real file system contents with full keyboard navigation. Directories can be entered and exited. Current path displayed in header. Status bar shows relevant key hints.
  </done>
</task>

</tasks>

<verification>
1. `cargo build` succeeds
2. Files tab (press 2) shows current directory contents
3. Directories shown with trailing `/`, sorted before files
4. Files show human-readable sizes
5. j/k or arrows scroll through list with visible selection highlight
6. Enter opens directories, Backspace goes to parent
7. Header shows current directory path
8. ".." entry appears for non-root directories
9. All existing tests pass (`cargo test`)
</verification>

<success_criteria>
- FileBrowserComponent lists directory contents using LocalBackend
- Keyboard navigation is responsive (j/k/Enter/Backspace)
- Directories sorted before files, both alphabetical
- Current path displayed prominently
- Component integrates with App's tab system
- Error handling for inaccessible directories (shows error message, stays in current dir)
</success_criteria>

<output>
After completion, create `.planning/phases/06-tui-mode/06-03-SUMMARY.md`
</output>
