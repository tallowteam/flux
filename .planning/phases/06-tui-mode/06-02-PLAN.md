---
phase: 06-tui-mode
plan: 02
type: execute
wave: 2
depends_on:
  - 06-01
files_modified:
  - src/tui/components/dashboard.rs
  - src/tui/components/mod.rs
  - src/tui/app.rs
autonomous: true
requirements:
  - TUI-02

must_haves:
  truths:
    - "User can see a table of active/recent transfers with ID, source, dest, progress, speed"
    - "User can see a speed sparkline graph showing transfer speed over time"
    - "User can see progress gauges for individual transfers"
    - "Transfer data updates in real-time (on tick events)"
    - "User can scroll through transfer list with j/k or arrow keys"
  artifacts:
    - path: "src/tui/components/dashboard.rs"
      provides: "DashboardComponent with transfer table, speed sparkline, progress rendering"
      contains: "DashboardComponent"
      min_lines: 100
  key_links:
    - from: "src/tui/components/dashboard.rs"
      to: "src/queue/state.rs"
      via: "Reads QueueStore entries to display transfers"
      pattern: "QueueStore|QueueEntry"
    - from: "src/tui/app.rs"
      to: "src/tui/components/dashboard.rs"
      via: "App delegates Dashboard tab rendering to DashboardComponent"
      pattern: "dashboard.*render|DashboardComponent"
---

<objective>
Create the Dashboard component showing real-time transfer monitoring with an active transfers table, speed sparkline graph, and progress gauges.

Purpose: This is the primary view users see when launching the TUI -- a real-time overview of all transfer activity with visual speed graphs, making transfer monitoring intuitive and informative.

Output: Working DashboardComponent that renders transfer data from QueueStore with speed visualization.
</objective>

<execution_context>
@C:/Users/trima/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/trima/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-tui-mode/06-RESEARCH.md
@.planning/phases/06-tui-mode/06-01-SUMMARY.md
@src/queue/state.rs
@src/queue/history.rs
@src/tui/components/mod.rs
@src/tui/app.rs
@src/tui/action.rs
@src/tui/theme.rs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create SpeedHistory ring buffer and DashboardState</name>
  <files>
    src/tui/components/dashboard.rs
  </files>
  <action>
1. Create `src/tui/components/dashboard.rs` with the following structures:

   **SpeedHistory** (ring buffer for sparkline data):
   ```rust
   pub struct SpeedHistory {
       samples: VecDeque<u64>,  // bytes/sec samples
       capacity: usize,
   }
   ```
   - `new(capacity: usize)` -- typically 60 for 60 seconds of history
   - `push(bytes_per_sec: u64)` -- push sample, pop front if at capacity
   - `as_slice() -> Vec<u64>` -- return samples as vector for Sparkline widget
   - `peak() -> u64` -- return max sample for label display

   **TransferInfo** (display-friendly transfer snapshot):
   ```rust
   pub struct TransferInfo {
       pub id: u64,
       pub source: String,
       pub dest: String,
       pub status: String,
       pub progress_pct: u16,    // 0-100
       pub speed_bps: u64,       // bytes per second
       pub bytes_transferred: u64,
       pub total_bytes: u64,
   }
   ```
   This is a view model -- the dashboard creates these from QueueStore entries. For now, since the existing QueueEntry doesn't track real-time progress (no `total_bytes` or live `speed`), populate with what's available:
   - `id`, `source`, `dest`, `status` from QueueEntry
   - `progress_pct` = 0 for running (real progress requires the progress channel refactor mentioned in research -- defer to integration)
   - `speed_bps` = 0 for now (same reason)
   - `bytes_transferred` from QueueEntry.bytes_transferred

   **DashboardComponent**:
   ```rust
   pub struct DashboardComponent {
       transfers: Vec<TransferInfo>,
       table_state: TableState,
       speed_history: SpeedHistory,
       total_speed: u64,
   }
   ```
   - `new()` constructor with empty state, SpeedHistory capacity 60
   - Implement `Component` trait
   - `pub fn update_transfers(&mut self, entries: &[QueueEntry])` -- refresh transfer list from QueueStore data, compute total speed, push to speed_history
   - `pub fn set_mock_data(&mut self)` -- for development/testing, populate with sample transfers so the dashboard isn't empty when no real transfers are running. Include 2-3 fake entries with various statuses.
  </action>
  <verify>
    `cargo check` passes. The module compiles with all struct definitions.
  </verify>
  <done>
    SpeedHistory ring buffer, TransferInfo view model, and DashboardComponent struct exist with data management methods.
  </done>
</task>

<task type="auto">
  <name>Task 2: Implement Dashboard rendering with table, sparkline, and gauges</name>
  <files>
    src/tui/components/dashboard.rs
    src/tui/components/mod.rs
    src/tui/app.rs
  </files>
  <action>
1. In `src/tui/components/dashboard.rs`, implement the `Component::render` method:

   **Layout** (vertical split of the dashboard area):
   ```rust
   let chunks = Layout::default()
       .direction(Direction::Vertical)
       .constraints([
           Constraint::Min(5),        // Active transfers table
           Constraint::Length(7),     // Speed sparkline
       ])
       .split(area);
   ```

   **Transfers Table** (top section):
   - Use `Table` widget with `TableState` for scrollable selection
   - Columns: ID (5 wide), Source (30%), Dest (30%), Status (10 wide), Progress (10 wide), Speed (12 wide)
   - Header row styled with `theme::HEADER`
   - Selected row highlighted with `theme::SELECTED`
   - Wrap in `Block::bordered().title("Active Transfers")`
   - For each TransferInfo, create a `Row` with cells. Color-code status: Running=Green, Paused=Yellow, Failed=Red, Pending=Gray, Completed=Green
   - Show progress as percentage (e.g., "45%") or a mini gauge if space permits
   - Show speed as human-readable (e.g., "12.5 MB/s") using bytesize crate formatting
   - Render with `frame.render_stateful_widget(table, chunks[0], &mut self.table_state)`

   **Speed Sparkline** (bottom section):
   - Use `Sparkline` widget with data from `self.speed_history.as_slice()`
   - Style with `theme::SPEED` (cyan)
   - Block title: `"Transfer Speed (peak: X MB/s)"` showing peak speed
   - If no data, show empty sparkline with title "Transfer Speed (no data)"

2. Implement `Component::handle_key_event`:
   - `KeyCode::Up | KeyCode::Char('k')` -> select previous row in table_state, return `Action::ScrollUp`
   - `KeyCode::Down | KeyCode::Char('j')` -> select next row in table_state, return `Action::ScrollDown`
   - Default -> `Action::Noop`

3. Implement `Component::update`:
   - Load QueueStore from data directory (best-effort, ignore errors)
   - Call `update_transfers()` with current queue entries
   - This runs on each tick event

4. In `src/tui/components/mod.rs`:
   - Add `pub mod dashboard;`

5. In `src/tui/app.rs`:
   - Replace the Dashboard tab placeholder with a real `DashboardComponent`
   - Add `dashboard: DashboardComponent` field to App struct
   - In `App::new()`, create `DashboardComponent::new()` and optionally call `set_mock_data()` for initial display
   - In `App::render()`, when active_tab is Dashboard, call `self.dashboard.render(frame, content_area)`
   - In `App::handle_key_event()`, when active_tab is Dashboard, delegate to `self.dashboard.handle_key_event(key)`
   - In `App::on_tick()`, call `self.dashboard.update()`
  </action>
  <verify>
    `cargo build` succeeds. Run `flux ui` -- Dashboard tab shows a transfers table (with mock data or empty), a speed sparkline area, and j/k scrolling works in the table. Tab switching still works. Quit with 'q' works.
  </verify>
  <done>
    Dashboard tab shows active transfers table with scrollable selection and speed sparkline. Data updates on tick. Table supports j/k navigation. Speed graph renders with sparkline widget.
  </done>
</task>

</tasks>

<verification>
1. `cargo build` succeeds
2. `flux ui` shows Dashboard tab as default with transfers table and speed sparkline
3. j/k or arrow keys scroll through transfer rows (visible with mock data)
4. Speed sparkline renders in the bottom section
5. Tab switching to other tabs and back to Dashboard preserves state
6. All existing tests pass (`cargo test`)
</verification>

<success_criteria>
- DashboardComponent renders transfers table with proper column layout
- SpeedHistory ring buffer collects and displays speed data via Sparkline widget
- Table is scrollable with keyboard navigation
- Mock data provides visible content for development
- Component integrates cleanly with App's tab system
</success_criteria>

<output>
After completion, create `.planning/phases/06-tui-mode/06-02-SUMMARY.md`
</output>
