---
phase: 01-foundation
plan: 03
type: execute
wave: 3
depends_on:
  - "01-01"
  - "01-02"
files_modified:
  - src/transfer/filter.rs
  - src/transfer/mod.rs
  - src/main.rs
  - tests/integration.rs
autonomous: true
requirements:
  - CORE-02
  - CORE-06
  - CORE-07
  - CORE-09

must_haves:
  truths:
    - "User can copy a directory recursively with `flux cp -r source/ dest/` preserving structure"
    - "User can exclude files with `flux cp -r --exclude '*.log' source/ dest/` and .log files are not copied"
    - "User can include only specific files with `flux cp -r --include '*.txt' source/ dest/`"
    - "Trailing slash on source means copy contents; no trailing slash means copy directory itself into dest"
    - "Permission errors on individual files don't abort entire directory copy; errors are reported in summary"
    - "Directory copy shows progress bar counting files transferred"
    - "Tool works correctly on Windows paths (backslashes, drive letters)"
  artifacts:
    - path: "src/transfer/filter.rs"
      provides: "TransferFilter with globset include/exclude pattern matching"
      contains: "TransferFilter"
    - path: "src/transfer/mod.rs"
      provides: "execute_copy handles both single-file and recursive directory copy"
      contains: "copy_directory"
    - path: "tests/integration.rs"
      provides: "End-to-end tests using assert_cmd and tempfile"
      contains: "assert_cmd"
  key_links:
    - from: "src/transfer/mod.rs"
      to: "src/transfer/filter.rs"
      via: "TransferFilter::new() created from --exclude/--include args"
      pattern: "TransferFilter::new"
    - from: "src/transfer/mod.rs"
      to: "src/transfer/copy.rs"
      via: "copy_file_with_progress called for each file in directory walk"
      pattern: "copy_file_with_progress"
    - from: "src/transfer/mod.rs"
      to: "src/progress/bar.rs"
      via: "create_directory_progress for overall file count progress"
      pattern: "create_directory_progress"
    - from: "tests/integration.rs"
      to: "flux binary"
      via: "assert_cmd::Command for end-to-end CLI tests"
      pattern: "Command::cargo_bin"
---

<objective>
Implement glob-based file filtering, recursive directory copy with progress, and end-to-end integration tests for the complete Phase 1 feature set.

Purpose: Complete the Phase 1 user experience — recursive copy with filtering is the primary use case. Integration tests verify everything works end-to-end as a CLI tool.
Output: `flux cp -r --exclude "*.log" source/ dest/` copies a directory tree, excludes matching files, shows file-count progress, and reports any errors in a summary.
</objective>

<execution_context>
@C:/Users/trima/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/trima/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-foundation/01-RESEARCH.md
@.planning/phases/01-foundation/01-01-SUMMARY.md
@.planning/phases/01-foundation/01-02-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Implement glob filtering and recursive directory copy</name>
  <files>
    src/transfer/filter.rs
    src/transfer/mod.rs
  </files>
  <action>
**src/transfer/filter.rs:** Implement TransferFilter exactly as in research Pattern 3:

- `TransferFilter` struct with `excludes: Option<GlobSet>`, `includes: Option<GlobSet>`
- `TransferFilter::new(exclude_patterns: &[String], include_patterns: &[String]) -> Result<Self, FluxError>`:
  - Build GlobSet from exclude patterns using GlobSetBuilder. If empty, set to None.
  - Build GlobSet from include patterns similarly. If empty, set to None.
  - Map `globset::Error` to `FluxError::InvalidPattern`
- `should_transfer(&self, path: &Path) -> bool`:
  - If excludes match the path, return false
  - If includes exist and none match the path, return false
  - Otherwise return true
- `is_excluded_dir(&self, entry: &walkdir::DirEntry) -> bool`:
  - Only check excludes (not includes) for directory pruning
  - This enables early pruning in walkdir::filter_entry
  - Return true if the directory itself matches an exclude pattern

Add unit tests in `#[cfg(test)]` module:
- Test: no patterns means everything transfers
- Test: exclude "*.log" skips log files but not txt files
- Test: include "*.rs" only transfers .rs files
- Test: exclude + include combination works correctly
- Test: directory pattern like "build/**" excludes entire subtree

**src/transfer/mod.rs:** Add `pub mod filter;` and implement directory copy:

- Define `TransferResult` struct: `files_copied: u64`, `bytes_copied: u64`, `errors: Vec<(PathBuf, FluxError)>`
  - Methods: `add_success(bytes: u64)`, `add_error(path: PathBuf, err: FluxError)`

- `fn copy_directory(source: &Path, dest: &Path, filter: &TransferFilter, quiet: bool) -> Result<TransferResult, FluxError>`:
  - Determine trailing slash behavior: if source path string ends with '/' or '\', copy CONTENTS of source into dest. Otherwise, copy source directory itself into dest (create dest/source_dirname/).
  - Normalize: strip trailing separator from source for walkdir, but remember the flag.
  - First pass (count): Walk source with `WalkDir::new(source)`, filter with `filter_entry(|e| !filter.is_excluded_dir(e))`, count files that pass `filter.should_transfer()`. This is for the progress bar total.
  - Create directory progress bar: `create_directory_progress(file_count, quiet)`
  - Second pass (copy): Walk source again with same filter.
    - For each entry, compute relative path from source using `strip_prefix`.
    - Compute dest_path: if copying contents, `dest.join(relative)`. If copying directory, `dest.join(source_dirname).join(relative)`.
    - If entry is a directory: `std::fs::create_dir_all(&dest_path)?`
    - If entry is a file and `filter.should_transfer(entry.path())`:
      - Ensure parent dir exists
      - Create a per-file hidden progress bar (or reuse a simple counter — don't nest visible progress bars for Phase 1)
      - Call `copy_file_with_progress(entry.path(), &dest_path, &per_file_progress)` (use ProgressBar::hidden() for per-file since directory progress tracks file count)
      - On success: `result.add_success(bytes)`, increment directory progress
      - On error: `result.add_error(entry.path().to_owned(), err)`, increment directory progress, continue (do NOT bail)
  - After walk: `progress.finish_with_message("done")`
  - If result has errors and !quiet: print summary "Completed with {n} error(s):" and list each error path + message
  - Return result

- Update `execute_copy()`:
  - Create `TransferFilter::new(&args.exclude, &args.include)?`
  - For single file: check filter.should_transfer on the source. If excluded, print info message and return Ok.
  - For directory (source.is_dir() AND args.recursive): call `copy_directory()`
  - Print final summary: "Copied {files} file(s), {bytes} bytes" using tracing::info
  - If TransferResult has errors, return an appropriate error (or just log, since individual errors were reported)

Cross-platform: Use `std::path::MAIN_SEPARATOR` or `.ends_with(std::path::is_separator)` for trailing slash detection. Actually, check both '/' and '\\' explicitly since users may use either on Windows. Use `path.to_string_lossy()` for the trailing slash check.
  </action>
  <verify>
Run `cargo build` — must compile.

Create test directory structure:
```
mkdir -p /tmp/flux_test_dir/sub1 /tmp/flux_test_dir/sub2
echo "file1" > /tmp/flux_test_dir/file1.txt
echo "file2" > /tmp/flux_test_dir/sub1/file2.txt
echo "log1" > /tmp/flux_test_dir/sub1/debug.log
echo "file3" > /tmp/flux_test_dir/sub2/file3.txt
```

Test recursive copy:
1. `cargo run -- cp -r /tmp/flux_test_dir /tmp/flux_test_dest` — all files copied, structure preserved
2. Verify: /tmp/flux_test_dest/flux_test_dir/file1.txt exists (directory itself copied)

Test trailing slash:
3. `cargo run -- cp -r /tmp/flux_test_dir/ /tmp/flux_test_dest2/` — contents copied directly
4. Verify: /tmp/flux_test_dest2/file1.txt exists (contents, not nested)

Test exclude:
5. `cargo run -- cp -r --exclude "*.log" /tmp/flux_test_dir/ /tmp/flux_test_dest3/`
6. Verify: debug.log NOT in dest, txt files ARE in dest

Test include:
7. `cargo run -- cp -r --include "*.txt" /tmp/flux_test_dir/ /tmp/flux_test_dest4/`
8. Verify: only .txt files in dest

Run `cargo test` — all unit tests pass.
  </verify>
  <done>
Recursive directory copy works with `flux cp -r source/ dest/`. Trailing slash semantics work (contents vs directory). Exclude patterns skip matching files. Include patterns only transfer matching files. Permission errors on individual files are reported but don't abort the copy. Progress bar shows file count during directory copy. TransferFilter unit tests pass.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add end-to-end integration tests with assert_cmd</name>
  <files>
    tests/integration.rs
  </files>
  <action>
**tests/integration.rs:** Create comprehensive integration tests using `assert_cmd` and `tempfile`:

Use `Command::cargo_bin("flux").unwrap()` to get the built binary.

**Test 1: Single file copy**
- Create tempdir, write "hello flux" to source.txt inside it
- Run: `flux cp {source.txt} {dest.txt}`
- Assert: exit code 0
- Assert: dest.txt exists and content matches "hello flux"

**Test 2: Single file copy — source not found**
- Run: `flux cp /nonexistent/path.txt {tempdir}/dest.txt`
- Assert: exit code 1
- Assert: stderr contains "Source not found"
- Assert: stderr contains "hint:"

**Test 3: Directory copy without -r flag**
- Create tempdir with a subdirectory
- Run: `flux cp {subdir} {dest}`
- Assert: exit code 1
- Assert: stderr contains "use -r flag"

**Test 4: Recursive directory copy**
- Create tempdir with nested structure: dir/a.txt, dir/sub/b.txt
- Run: `flux cp -r {dir}/ {dest}/`
- Assert: exit code 0
- Assert: {dest}/a.txt exists with correct content
- Assert: {dest}/sub/b.txt exists with correct content

**Test 5: Exclude pattern**
- Create tempdir: dir/keep.txt, dir/skip.log, dir/sub/also_skip.log
- Run: `flux cp -r --exclude "*.log" {dir}/ {dest}/`
- Assert: exit code 0
- Assert: {dest}/keep.txt exists
- Assert: {dest}/skip.log does NOT exist
- Assert: {dest}/sub/also_skip.log does NOT exist

**Test 6: Include pattern**
- Create tempdir: dir/want.rs, dir/ignore.txt, dir/sub/want2.rs
- Run: `flux cp -r --include "*.rs" {dir}/ {dest}/`
- Assert: exit code 0
- Assert: {dest}/want.rs exists
- Assert: {dest}/ignore.txt does NOT exist
- Assert: {dest}/sub/want2.rs exists

**Test 7: Quiet mode suppresses output**
- Create tempdir with source file
- Run: `flux -q cp {source} {dest}`
- Assert: exit code 0
- Assert: stderr is empty (or minimal — no progress bar characters)
- Assert: dest file exists

**Test 8: Help text**
- Run: `flux --help`
- Assert: exit code 0
- Assert: stdout contains "flux"
- Assert: stdout contains "cp"

**Test 9: Verbose mode accepted**
- Create tempdir with source file
- Run: `flux -v cp {source} {dest}`
- Assert: exit code 0 (verbose flag doesn't break anything)

**Test 10: Copy preserves content for binary-like data**
- Create tempdir, write 1MB of random-ish bytes (use a deterministic pattern: 0..255 repeated) to source.bin
- Run: `flux cp {source.bin} {dest.bin}`
- Assert: exit code 0
- Assert: dest.bin size matches source.bin size
- Assert: dest.bin content matches source.bin content (read both, compare)

Each test uses its own `tempfile::TempDir` for isolation. Tests must be independent and not depend on order.
  </action>
  <verify>
Run `cargo test -- --test-threads=1` (sequential to avoid parallel tempdir issues) — all 10 integration tests pass. Run `cargo test` (parallel) — all tests still pass (since each uses its own tempdir).
  </verify>
  <done>
10 integration tests cover: single file copy, error messages with hints, directory-without-recursive error, recursive directory copy, exclude patterns, include patterns, quiet mode, help text, verbose mode, and binary file copy. All tests pass. Tests use tempfile for isolation and assert_cmd for CLI invocation.
  </done>
</task>

</tasks>

<verification>
1. `cargo build` succeeds
2. `cargo test` — all unit and integration tests pass
3. `flux cp source.txt dest.txt` — single file copy works with progress
4. `flux cp -r dir/ dest/` — recursive copy preserves structure
5. `flux cp -r --exclude "*.log" dir/ dest/` — logs excluded
6. `flux cp -r --include "*.txt" dir/ dest/` — only txt files copied
7. `flux cp nonexistent.txt dest.txt` — helpful error with hint
8. `flux cp dir/ dest/` (no -r) — error with "use -r" hint
9. `flux -q cp file.txt dest.txt` — no progress output
10. `flux -v cp file.txt dest.txt` — verbose mode works
11. Trailing slash behavior: contents vs directory-into-dest
</verification>

<success_criteria>
- Recursive directory copy works preserving full directory structure
- Glob-based exclude patterns prevent matching files from being copied
- Glob-based include patterns limit copy to only matching files
- Trailing slash on source means "copy contents" (rsync convention)
- Individual file errors during directory copy are collected and reported, not fatal
- 10 integration tests pass covering all Phase 1 success criteria
- Works on current platform (Windows) with proper path handling
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation/01-03-SUMMARY.md`
</output>
